/* COPYRIGHT (C) HARRY CLARK 2024 */

/* SEGA MEGA DRIVE EMULATOR */

/* THIS FILE PERTAINS TOWARDS THE MAIN FUNCTIONALITY OF THE CONSOLE */

/* NESTED INCLUDES */

#include "md.h"
#include "68000.h"
#include "common.h"

#ifdef USE_MD

/* INITIALISE THE CONSOLE THROUGH THE PRE-REQUISTIES */
/* ESTABLISHED IN THE CORRESPONDING HEADER FILES */

/* THIS FUNCTION ENCOMPASSES THE FUNCTIONALITY OF ENABLING */
/* THE MEMORY MANAGEMENT UNIT FOR ALLOWING THE CONSOLE TO BEGIN */
/* IT'S INITIAL COMMUNICATIONS BETWEEN M68K AND Z80 ON STARTUP */

STATIC
void MD_INIT(void)
{
    struct MD* MD_CONSOLE;
    struct CPU_68K* CPU_68K;

    if((MD_CONSOLE->SYSTEM_TYPE == SYSTEM_MD))
    {
        M68K_INIT();
        CPU_68K->ADDRESS_RT_CHECK = (U8*)malloc(sizeof(CPU_68K->ERROR_ADDRESS));

        /* ASSUMING THAT THE ABOVE COROUTINE HAVE BEEN ESTABLISHED */
        /* THE MEMORY MAP WILL NOW BE INITIALISED */

        /* THIS FUNCTIONALITY IS SIMILAR TO THE WAY IN WHICH IT WORKS */
        /* ON REAL HARDWARE WITH THE WAY IN WHICH THE VECTOR TABLE INITIALISES */ 

        for (int i = 0; i < 0xFF; i++)
        {
            CPU_68K->MEMORY_MAP[i].BASE = (U8*)malloc(sizeof(MD_CONSOLE->BOOT_RAM));
            CPU_68K->MEMORY_MAP[i].MEMORY_READ_8 = M68K_READ_8(CPU_68K->MEMORY_DATA, CPU_68K->MEMORY_ADDRESS);
            CPU_68K->MEMORY_MAP[i].MEMORY_WRITE_8 = M68K_WRITE_8(CPU_68K->MEMORY_DATA, CPU_68K->MEMORY_ADDRESS, CPU_68K->MEMORY_POINTER);
            CPU_68K->MEMORY_MAP[i].MEMORY_READ_16 = M68K_READ_16(CPU_68K->MEMORY_DATA, CPU_68K->MEMORY_ADDRESS);
            CPU_68K->MEMORY_MAP[i].MEMORY_WRITE_16 = M68K_WRITE_16(CPU_68K->MEMORY_DATA, CPU_68K->MEMORY_ADDRESS, CPU_68K->MEMORY_POINTER);

            CPU_68K->Z80_MEM[i].READ = Z80_READ(CPU_68K->MEMORY_DATA, CPU_68K->MEMORY_ADDRESS);
            CPU_68K->Z80_MEM[i].WRITE = Z80_WRITE(CPU_68K->MEMORY_DATA, CPU_68K->MEMORY_ADDRESS, CPU_68K->MEMORY_POINTER);
        }

        for (int i = 0xC; i < 0xFF; i++)
        {
            CPU_68K->MEMORY_MAP[i].MEMORY_READ_8 = VDP_READ_BYTE(CPU_68K->MEMORY_DATA, CPU_68K->MEMORY_ADDRESS);
            CPU_68K->MEMORY_MAP[i].MEMORY_READ_8 = VDP_WRITE_BYTE(CPU_68K->MEMORY_DATA, CPU_68K->MEMORY_ADDRESS, CPU_68K->MEMORY_POINTER);
        }
        
    }
}

#endif
